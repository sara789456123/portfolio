<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cat Game</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        background-color: #87ceeb;
      }
      #record {
        font-size: 24px;
        font-family: Arial, sans-serif;
        margin-bottom: 10px;
        color: black;
      }
      #gameCanvas {
        border: 2px solid black;
        margin-bottom: 20px;
      }
      #restartButton {
        padding: 17px 40px;
        border-radius: 10px;
        border: 0;
        background-color: rgb(255, 56, 86);
        letter-spacing: 1.5px;
        font-size: 15px;
        transition: all 0.3s ease;
        box-shadow: rgb(201, 46, 70) 0px 10px 0px 0px;
        color: hsl(0, 0%, 100%);
        cursor: pointer;
      }
      #restartButton:hover {
        box-shadow: rgb(201, 46, 70) 0px 7px 0px 0px;
      }
      #restartButton:active {
        background-color: rgb(255, 56, 86);
        box-shadow: rgb(201, 46, 70) 0px 0px 0px 0px;
        transform: translateY(5px);
        transition: 200ms;
      }
      #btnRetour {
        position: absolute;
        left: 20px;
        top: 0px;
        background-color: #ecf0f3;
        box-shadow: #dde9f2;
        padding: 17px 40px;
        border-radius: 10px;
        border: 0;
      }
      #btnRetour:hover {
        box-shadow: rgb(195, 200, 229) 0px 7px 0px 0px;
      }
    </style>
  </head>
  <body>
    <button id="btnRetour" onclick="location.href='../index.html';">
      Retour</button
    ><br />
    <div id="record">Record: 0</div>
    <div id="bonusCount">Carotte: 0</div>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <button id="restartButton">Restart</button>
    <img id="platformSprite" src="./img/plateforme.png" style="display: none" />
    <img id="catSpriteRight" src="./img/catdroite.png" style="display: none" />
    <img id="catSpriteLeft" src="./img/catgauche.png" style="display: none" />
    <img id="bonusSprite" src="./img/bonus.png" style="display: none" />

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const restartButton = document.getElementById("restartButton");
      const recordElement = document.getElementById("record");
      const bonusCountElement = document.getElementById("bonusCount");

      const platformSprite = new Image();
      platformSprite.src = "./img/plateforme.png";

      const catSpriteRight = new Image();
      catSpriteRight.src = "./img/catdroite.png";

      const catSpriteLeft = new Image();
      catSpriteLeft.src = "./img/catgauche.png";

      const bonusSprite = new Image();
      bonusSprite.src = "./img/bonus.png";

      const cat = {
        x: 0,
        y: 0,
        width: 50,
        height: 50,
        dx: 0,
        dy: 0,
        speed: 3,
        jumpSpeed: 5,
        jumpStrength: -15,
        isJumping: false,
        direction: "right",
      };

      let platforms = [];
      let bonuses = [];
      let gameOver = false;
      let cameraX = 0;
      let score = 0;
      let record = 0;
      let bonusCount = 0;
      let hasLostOnce = false;
      const platformSpacing = 200;
      const gravity = 0.7;
      const minPlatformHeight = 180;
      const maxPlatformHeight = 300;
      const platformWidth = 100;
      const platformHeight = 20;

      function drawCat() {
        const catSprite =
          cat.direction === "left" ? catSpriteLeft : catSpriteRight;
        ctx.drawImage(catSprite, cat.x - cameraX, cat.y, cat.width, cat.height);
      }

      function drawPlatforms() {
        platforms.forEach((platform) => {
          ctx.drawImage(
            platformSprite,
            platform.x - cameraX,
            platform.y,
            platform.width,
            platform.height
          );
        });
      }

      function drawBonuses() {
        bonuses.forEach((bonus) => {
          ctx.drawImage(
            bonusSprite,
            bonus.x - cameraX,
            bonus.y,
            bonus.width,
            bonus.height
          );
        });
      }

      function drawScore() {
        ctx.fillStyle = "black";
        ctx.font = "24px Arial";
        ctx.fillText(`Score: ${score}`, 10, 30);
      }

      /*   function drawBonusCount() {
        ctx.fillStyle = "black";
        ctx.font = "24px Arial";
        ctx.fillText(`Carotte: ${bonusCount}`, 10, 60);
      }*/

      function update() {
        if (gameOver) return;

        const prevX = cat.x;
        const prevY = cat.y;

        cat.y += cat.dy;
        cat.x += cat.dx;

        score += cat.dx;

        if (score > record) {
          record = score;
          recordElement.textContent = `Record: ${record}`;
        }

        cat.isJumping = true;
        let onPlatform = false;

        platforms.forEach((platform) => {
          if (
            cat.x < platform.x + platform.width &&
            cat.x + cat.width > platform.x &&
            cat.y < platform.y + platform.height &&
            cat.y + cat.height >= platform.y &&
            cat.dy >= 0
          ) {
            cat.y = platform.y - cat.height;
            cat.dy = 0;
            cat.isJumping = false;
            onPlatform = true;
          }

          // Check for horizontal collision
          if (
            cat.x < platform.x + platform.width &&
            cat.x + cat.width > platform.x &&
            cat.y < platform.y + platform.height &&
            cat.y + cat.height > platform.y
          ) {
            if (cat.dx > 0 && prevX + cat.width <= platform.x) {
              cat.x = platform.x - cat.width;
            } else if (cat.dx < 0 && prevX >= platform.x + platform.width) {
              cat.x = platform.x + platform.width;
            }
          }
        });

        // Check for bonus collision
        for (let i = bonuses.length - 1; i >= 0; i--) {
          const bonus = bonuses[i];
          if (
            cat.x < bonus.x + bonus.width &&
            cat.x + cat.width > bonus.x &&
            cat.y < bonus.y + bonus.height &&
            cat.y + cat.height > bonus.y
          ) {
            // Remove the bonus and add to bonus count
            bonuses.splice(i, 1);
            bonusCount += 1;
            bonusCountElement.textContent = `Bonus: ${bonusCount}`;
          }
        }

        if (!onPlatform) {
          cat.isJumping = true;
        }

        if (cat.y + cat.height > canvas.height) {
          gameOver = true;
          hasLostOnce = true;
        } else {
          cat.dy += gravity;
        }

        if (cat.x + cat.width > canvas.width / 2) {
          cameraX = cat.x - canvas.width / 2;
        }

        generatePlatforms();
      }

      function generatePlatforms() {
        const lastPlatform = platforms[platforms.length - 1];
        if (
          !lastPlatform ||
          lastPlatform.x < canvas.width + cameraX + platformSpacing
        ) {
          const platformX = lastPlatform ? lastPlatform.x + platformSpacing : 0;
          const platformY = Math.floor(
            Math.random() * (maxPlatformHeight - minPlatformHeight) +
              minPlatformHeight
          );

          platforms.push({
            x: platformX,
            y: platformY,
            width: platformWidth,
            height: platformHeight,
          });

          // Ajouter un bonus aléatoirement sur certaines plateformes
          if (Math.random() < 0.2) {
            // 20% de chance d'ajouter un bonus
            bonuses.push({
              x: platformX + platformWidth / 2 - 15, // Position centrée sur la plateforme
              y: platformY - 30, // Position au-dessus de la plateforme
              width: 30,
              height: 30,
            });
          }

          if (platforms.length === 1) {
            cat.x = platformX;
            cat.y = platformY - cat.height;
            cat.dy = 0;
          }
        }
      }

      function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "skyblue";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        drawPlatforms();
        drawCat();
        drawBonuses();
        drawScore();
        drawBonusCount();

        if (gameOver) {
          ctx.fillStyle = "black";
          ctx.font = "48px Arial";
          ctx.fillText("Perdu", canvas.width / 2 - 50, canvas.height / 2);
        } else {
          update();
          requestAnimationFrame(gameLoop);
        }
      }

      function restartGame() {
        platforms = [];
        generatePlatforms();
        cat.dx = 0;
        cat.dy = 0;
        cat.isJumping = false;
        cat.direction = "right"; // Reset direction
        gameOver = false;
        cameraX = 0;
        score = 0;
        gameLoop();
      }

      function startGame() {
        if (
          catSpriteRight.complete &&
          catSpriteLeft.complete &&
          platformSprite.complete &&
          bonusSprite.complete
        ) {
          restartGame();
        } else {
          catSpriteRight.onload = restartGame;
          catSpriteLeft.onload = restartGame;
          platformSprite.onload = restartGame;
          bonusSprite.onload = restartGame;
        }
      }

      document.addEventListener("keydown", (event) => {
        if (gameOver) return;

        switch (event.key) {
          case "ArrowUp":
            if (!cat.isJumping) {
              cat.dy = cat.jumpStrength;
            }
            break;
          case "ArrowLeft":
            cat.dx = -cat.speed;
            cat.direction = "left"; // Update direction
            break;
          case "ArrowRight":
            cat.dx = cat.speed;
            cat.direction = "right"; // Update direction
            break;
        }
      });

      document.addEventListener("keyup", (event) => {
        switch (event.key) {
          case "ArrowLeft":
          case "ArrowRight":
            cat.dx = 0;
            break;
        }
      });

      restartButton.addEventListener("click", restartGame);

      startGame();
    </script>
  </body>
</html>
